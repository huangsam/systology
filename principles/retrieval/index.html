<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Retrieval & RAG - Systology</title><meta name=description content="Building robust retrieval systems and RAG pipelines."><link rel=canonical href=https://sambyte.net/systology/principles/retrieval/><link rel=icon href=/systology/favicon.svg type=image/svg+xml><meta name=robots content="index, follow"><script>try{localStorage.getItem("theme")==="dark"&&(document.documentElement.setAttribute("data-theme","dark"),document.documentElement.style.background="#0f1724")}catch{}</script><link rel=stylesheet href="/systology/css/styles.css?v=1772223161"><link rel=stylesheet href="/systology/css/syntax.css?v=1772223161"><link rel=stylesheet href="/systology/css/search.css?v=1772223161"></head><body><header class=site-header role=banner><div class="container header-inner"><a class=brand href=/systology/ aria-label=Systology><img src=/systology/favicon.svg alt class=logo-icon> Systology</a><nav class=site-nav role=navigation aria-label="Main navigation"><button class=search-toggle data-open-search aria-label=Search>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</button>
<button class=theme-toggle id=theme-toggle aria-label="Toggle dark mode">
<svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></nav></div></header><main id=content class="container prose"><article><header><div class=title-group><h1>Retrieval & RAG</h1></div><h2>Building robust retrieval systems and RAG pipelines.</h2><div class=tags><span>Tags:</span>
<a class=badge href=/systology/tags/retrieval/>retrieval</a></div></header><section><h2 id=local-vector-store-hygiene>Local Vector Store Hygiene</h2><p>Version vector indices to enable rollbacks and prune stale vectors to control storage costs. Maintain provenance metadata for audit and understand what you&rsquo;re indexing.</p><p>Treat your vector index like a database: it has versions, needs backups, and accumulates cruft. Use a naming convention like <code>index_v{N}_{timestamp}</code> and maintain a manifest that maps each index version to the embedding model, chunking strategy, and source document set that produced it. Prune vectors for deleted or updated documents on a schedule. Without provenance metadata, you can&rsquo;t answer &ldquo;why did the system retrieve this irrelevant result?"‚Äîwhich makes debugging retrieval quality nearly impossible.</p><p>See <a href=https://sambyte.net/systology/deep-dives/ragchain/>Ragchain</a> for a local-first RAG implementation that manages vector indices alongside BM25 indices.</p><p><strong>Anti-pattern ‚Äî Append-only Index Forever:</strong> Adding new vectors without ever removing stale ones. Over time, the index accumulates outdated, deleted, or superseded documents that pollute search results with irrelevant content. A user deletes a page, but the vector persists and surfaces it in searches. Implement garbage collection tied to your document lifecycle.</p><h2 id=hybrid-retrieval-strategy>Hybrid Retrieval Strategy</h2><p>Combine lexical (BM25) and semantic retrieval for robustness‚Äîneither alone handles all query types well. Tune fusion weights per query intent class and experiment with expansion and reranking.</p><p>BM25 excels at exact keyword matches and rare terms (proper nouns, error codes, product IDs). Semantic search handles paraphrases, conceptual queries, and fuzzy matches. For a query like &ldquo;Python connection pool timeout error,&rdquo; BM25 finds documents containing those exact terms while semantic search finds documents about &ldquo;database client configuration&rdquo; that discuss the same concept differently. Reciprocal rank fusion (RRF) or weighted linear combination of scores provides a simple, effective fusion strategy.</p><p>See the <a href=https://sambyte.net/systology/designs/search-retrieval/>Search & Retrieval</a> design for a production architecture combining BM25 and vector retrieval with reranking at scale.</p><p><strong>Anti-pattern ‚Äî Semantic-only Retrieval:</strong> Relying exclusively on vector search. Embeddings are great for conceptual similarity but terrible for exact matches: searching for the error code <code>ERR_CONNECTION_REFUSED</code> via semantic search returns results about &ldquo;network problems&rdquo; rather than the exact error. Hybrid retrieval covers both precision and recall.</p><h2 id=embedding-stability>Embedding Stability</h2><p>Pin embedding model versions to ensure consistent representations and only re-embed when models or schemas change. Unstable embeddings make debugging retrieval mysterious.</p><p>An embedding model maps text to a vector space. If you switch models or even update to a new version, the vector space changes‚Äîdistances between documents shift, and retrieval quality can degrade unpredictably. Pin the exact model version (<code>sentence-transformers/all-MiniLM-L6-v2@v1.0.0</code>) and only re-embed the entire corpus when you deliberately upgrade. Test retrieval quality before and after to validate the upgrade.</p><p><strong>Anti-pattern ‚Äî Auto-updating Embedding Models:</strong> Using <code>latest</code> tags for embedding models in production. A model update silently changes the vector space, new documents are embedded differently than old ones, and retrieval quality degrades over weeks as the index becomes a mix of two incompatible vector spaces. Pin versions and re-embed atomically.</p><h2 id=evaluation--benchmarks>Evaluation & Benchmarks</h2><p>Automate MAP@k and MRR metrics with synthetic test suites and use LLM-as-judge for qualitative evaluation but validate against human labels. Maintain small dev sets for quick iteration without overfitting.</p><p>Build an evaluation suite with: (1) a curated set of 50‚Äì200 query-relevance pairs with human-labeled relevance grades, (2) automated metrics (MAP@10, MRR, NDCG@10) computed after each index or model change, and (3) regression tests that fail if metrics drop below a threshold. For RAG systems, evaluate both retrieval (did we fetch the right documents?) and generation (is the answer correct?) separately‚Äîa wrong answer from correct documents is a generation problem, not a retrieval problem.</p><p><strong>Anti-pattern ‚Äî Vibes-based Evaluation:</strong> Testing retrieval by manually typing a few queries and eyeballing results. This catches obvious failures but misses systematic issues (e.g., retrieval works for short queries but fails for long ones, or works for English but fails for other languages). Automated evaluation with diverse query sets catches these patterns.</p><p>See the <a href=https://sambyte.net/systology/principles/ml-experiments/>ML Experiments</a> principles for guidance on deterministic evaluation and reproducible benchmarking.</p><h2 id=latency-vs-quality-trade-offs>Latency vs. Quality Trade-offs</h2><p>Cache frequent queries and use approximate nearest neighbors for large-scale search, but time the tradeoff. Rerank only the top-k results to balance quality and speed.</p><p>For indices over ~1M vectors, exact nearest neighbor search becomes too slow for real-time queries. Use ANN algorithms (HNSW, IVF) that trade a small recall loss (~2‚Äì5%) for 100x speedup. Layer a cross-encoder reranker on top of the ANN&rsquo;s top-50 results to recover quality‚Äîthe reranker is expensive per-document but cheap when applied to only 50 candidates. Cache the full pipeline result for frequent queries (search logs reveal that 20% of queries account for 80% of traffic).</p><p><strong>Anti-pattern ‚Äî Exact Search at Scale:</strong> Running brute-force exact nearest neighbor on 10M vectors for every query. Response times of 5‚Äì10 seconds destroy user experience. ANN indices sacrifice negligible recall for orders-of-magnitude speedup‚Äîthe quality difference is invisible to users while the latency difference is not.</p><h2 id=privacy--locality>Privacy & Locality</h2><p>Default to local embeddings and LLMs to minimize data exposure outside your infrastructure. Require explicit opt-in for cloud services with clear data flow documentation.</p><p>Run embedding models locally using ONNX Runtime, llama.cpp, or similar lightweight inference runtimes. For LLM generation, local models (Llama, Mistral, Phi) running on-device provide privacy guarantees that cloud APIs cannot. When cloud LLMs are needed for quality (GPT-4, Claude), document the data flow explicitly: which user data is sent, to which endpoint, is it logged by the provider, and what&rsquo;s the retention policy?</p><p>See the <a href=https://sambyte.net/systology/principles/privacy-agents/>Privacy & Agents</a> principles for comprehensive guidance on local-first defaults and data minimization.</p><p><strong>Anti-pattern ‚Äî Embedding via Cloud API by Default:</strong> Sending every user query and document chunk to an external embedding API. Even if the provider&rsquo;s privacy policy is acceptable, this creates a dependency on network availability, introduces latency, incurs per-call costs, and sends potentially sensitive content over the wire. Local embedding models eliminate all four concerns.</p><h2 id=ingestion--incrementality>Ingestion & Incrementality</h2><p>Support incremental indexing to avoid rebuilds on every update and ensure ingest operations are idempotent. Use diff detection to identify changed documents efficiently.</p><p>For large document collections, full re-indexing is prohibitively expensive. Track document hashes or modification timestamps and only re-embed changed documents. Use a content-addressable storage pattern: hash the document content, check if the hash exists in the index, and skip if unchanged. For deletions, maintain a mapping from document IDs to vector IDs so you can remove stale vectors without scanning the entire index.</p><p>See the <a href=https://sambyte.net/systology/principles/migration-dedup/>Migration & Deduplication</a> principles for related guidance on idempotent operations and checkpointing that applies to incremental indexing.</p><p><strong>Anti-pattern ‚Äî Full Re-index on Every Change:</strong> Rebuilding the entire vector index when a single document changes. For a corpus of 100K documents, this means re-embedding all 100K documents (hours of compute) when only one changed. Incremental indexing reduces update cost from O(N) to O(1) per change.</p><h2 id=monitoring--drift-detection>Monitoring & Drift Detection</h2><p>Track relevance metrics and query performance over time to detect embedding drift. Schedule automated re-indexing when drift is detected.</p><p>Monitor retrieval quality continuously: track average relevance scores, click-through rates on search results, and query-to-no-result ratios over time. A gradual decline in these metrics indicates drift‚Äîyour corpus has changed but your index hasn&rsquo;t kept up, or the types of queries have shifted away from what your embedding model handles well. Set up automated alerts when metrics drop below baseline and trigger re-indexing or model evaluation.</p><p>See the <a href=https://sambyte.net/systology/principles/monitoring/>Monitoring & Observability</a> principles for broader guidance on SLIs, alerting, and dashboards that applies to retrieval system monitoring.</p><p><strong>Anti-pattern ‚Äî Set and Forget:</strong> Building a retrieval system, shipping it, and never monitoring retrieval quality. Over months, document additions, deletions, and updates cause the index to drift. New query patterns emerge that the original model handles poorly. Without monitoring, quality degrades silently until users complain‚Äîby which time trust is already eroded.</p><h2 id=decision-framework>Decision Framework</h2><p>Choose your retrieval strategy based on the structure of the data and the type of queries being performed:</p><table><thead><tr><th style=text-align:left>If you need&mldr;</th><th style=text-align:left>&mldr;choose this</th><th style=text-align:left>because&mldr;</th></tr></thead><tbody><tr><td style=text-align:left><strong>Exact Keyword Match</strong></td><td style=text-align:left>Lexical Search (BM25)</td><td style=text-align:left>Best for names, IDs, and specific technical terminology.</td></tr><tr><td style=text-align:left><strong>Semantic Meaning</strong></td><td style=text-align:left>Vector Search (RAG)</td><td style=text-align:left>Understands intent and concepts rather than just matching characters.</td></tr><tr><td style=text-align:left><strong>Complex Relations</strong></td><td style=text-align:left>Graph Search</td><td style=text-align:left>navigates connections between entities (e.g., social networks).</td></tr><tr><td style=text-align:left><strong>Real-time Updates</strong></td><td style=text-align:left>LSM-based Stores</td><td style=text-align:left>Optimized for high write volumes and point lookups for fresh data.</td></tr></tbody></table><p><strong>Decision Heuristic:</strong> &ldquo;Choose <strong>Hybrid Search</strong> (Lexical + Vector) when accuracy is more important than pure semantic novelty.&rdquo;</p></section><aside class=related><h3>Related</h3><ul><li><a href=/systology/deep-dives/ragchain/>Ragchain</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Local RAG stack (Chroma + Ollama) for private, reproducible retrieval and LLM usage; focuses on hybrid retrieval, index versioning, and evaluation.</small></li><li><a href=/systology/designs/search-retrieval/>Search & Retrieval Engine</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Design a high-performance search and retrieval engine for large document/media collections with low-latency ranking and scalable indexing.</small></li></ul></aside></article></main><footer class=site-footer role=contentinfo><div class="container footer-inner"><p class=copyright>&copy; 2026 Systology. All rights reserved.</p><div class=social-links><a href=https://github.com/huangsam target=_blank rel="noopener noreferrer" aria-label=GitHub><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=http://linkedin.com/in/sambyte target=_blank rel="noopener noreferrer" aria-label=LinkedIn><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></footer><div id=site-search-modal class=site-search-modal-container style=display:none><div class=site-search-overlay data-close-search></div><div class=site-search-modal><div class=site-search-header><div class=site-search-input-wrapper><span class=site-search-icon><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</span><input type=text class=site-search-input id=site-search-input placeholder="Search designs, principles, deep dives..." aria-label=Search autocomplete=off>
<button class=site-search-close data-close-search>&#215;</button></div></div><div class=site-search-body><div id=site-search-default class=site-search-default><div class=site-search-quick-links><a href=/systology/categories/ class=site-search-cta><span class=site-search-cta-icon>üìÇ</span>
<span class=site-search-cta-text>All Categories</span>
<span class=site-search-cta-arrow>‚Üí</span>
</a><a href=/systology/tags/ class=site-search-cta><span class=site-search-cta-icon>üè∑Ô∏è</span>
<span class=site-search-cta-text>All Tags</span>
<span class=site-search-cta-arrow>‚Üí</span></a></div></div><div id=site-search-results-list style=display:none></div></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){let i=null,o=null;const t=document.getElementById("site-search-modal"),n=document.getElementById("site-search-input"),s=document.getElementById("site-search-default"),e=document.getElementById("site-search-results-list"),d=document.querySelectorAll("[data-close-search]"),h=document.querySelectorAll("[data-open-search]");if(!t)return;document.body.appendChild(t);let l=!1;function u(){if(l)return;fetch("/systology/search-index.json").then(e=>e.json()).then(e=>{i=e.documents,l=!0}).catch(e=>console.error("Failed to load search index:",e))}function r(){u(),t.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{n.focus(),n.value.trim()?c(n.value):(s.style.display="block",e.style.display="none")},50)}function a(){t.style.display="none",document.body.style.overflow="",n.value="",e.innerHTML="",s.style.display="block",e.style.display="none"}h.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),r()})}),d.forEach(e=>{e.addEventListener("click",a)});function c(t){if(!i)return;if(!t.trim()){s.style.display="block",e.style.display="none",e.innerHTML="";return}s.style.display="none",e.style.display="block",t=t.toLowerCase();const n=i.filter(e=>{const n=e.content.toLowerCase(),s=e.title.toLowerCase(),o=(e.tags||[]).join(" ").toLowerCase();return n.includes(t)||s.includes(t)}).slice(0,15);n.length===0?e.innerHTML='<p class="site-search-no-results">No results found.</p>':e.innerHTML=n.map(e=>`
        <a href="${e.url}" class="site-search-result">
          <div class="site-search-result-title">${e.title}</div>
          <div class="site-search-result-preview">${e.preview}</div>
          <div class="site-search-result-meta">
            <span class="site-search-badge-category">${e.category}</span>
            ${e.tags.map(e=>`<span class="site-search-badge">${e}</span>`).join("")}
          </div>
        </a>
      `).join("")}n.addEventListener("input",function(e){o&&clearTimeout(o),o=setTimeout(()=>{c(e.target.value)},300)}),document.addEventListener("keydown",function(e){(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),t.style.display==="none"||t.style.display===""?r():a()),e.key==="Escape"&&t.style.display==="flex"&&a()})})</script><script>document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".pseudocode-toggle"),n=document.querySelectorAll(".pseudocode-modal-close"),s=document.querySelectorAll(".pseudocode-modal-overlay");function o(e){const t=document.getElementById(e);if(!t)return;t.classList.add("active"),t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const n=t.querySelector(".pseudocode-modal-close");n&&n.focus()}function e(e){if(!e)return;e.classList.remove("active"),e.setAttribute("aria-hidden","true"),document.body.style.overflow="";const t=document.querySelector(`.pseudocode-toggle[aria-controls="${e.id}"]`);t&&t.focus()}t.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("aria-controls");o(t)})}),n.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),s.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const t=document.querySelector(".pseudocode-modal.active");t&&e(t)}})})</script><script src=/systology/js/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){window.mermaid&&mermaid.initialize({startOnLoad:!0,theme:"base",securityLevel:"loose",themeVariables:{primaryColor:"#f3f4f6",primaryTextColor:"#0f1724",primaryBorderColor:"#2563eb",lineColor:"#6b7280",secondBkgColor:"#ffffff",tertiaryTextColor:"#6b7280",tertiaryColor:"#e6e9ee",noteBkgColor:"#f0f9ff",noteBorderColor:"#2563eb",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},flowchart:{useMaxWidth:!0,curve:"linear"},sequence:{useMaxWidth:!0},gantt:{useWidth:0[0]}});var e=document.getElementById("theme-toggle");e&&e.addEventListener("click",function(){var e=document.documentElement.getAttribute("data-theme")==="dark";document.documentElement.setAttribute("data-theme",e?"":"dark");try{localStorage.setItem("theme",e?"light":"dark")}catch{}})})</script></body></html>