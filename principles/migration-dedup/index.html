<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Migration & Deduplication - Systology</title><meta name=description content="Integrity and efficiency in migration/deduplication."><link rel=canonical href=https://sambyte.net/systology/principles/migration-dedup/><link rel=icon href=/systology/favicon.svg type=image/svg+xml><meta name=robots content="index, follow"><script>try{localStorage.getItem("theme")==="dark"&&document.documentElement.setAttribute("data-theme","dark")}catch{}document.documentElement.setAttribute("data-loading",""),requestAnimationFrame(function(){requestAnimationFrame(function(){document.documentElement.removeAttribute("data-loading")})})</script><style>html{background:#fff;color:#0f1724}html[data-theme=dark]{background:#0f1724;color:#e2e8f0}html[data-loading] *{transition:none!important}</style><link rel=stylesheet href=/systology/css/styles.css><link rel=stylesheet href=/systology/css/syntax.css><link rel=stylesheet href=/systology/css/search.css></head><body><header class=site-header role=banner><div class="container header-inner"><a class=brand href=/systology/ aria-label=Systology><img src=/systology/favicon.svg alt class=logo-icon> Systology</a><nav class=site-nav role=navigation aria-label="Main navigation"><button class=search-toggle data-open-search aria-label=Search>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</button>
<button class=theme-toggle id=theme-toggle aria-label="Toggle dark mode">
<svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></nav></div></header><main id=content class="container prose"><article><header><div class=title-group><h1>Migration & Deduplication</h1></div><h2>Integrity and efficiency in migration/deduplication.</h2><div class=tags><span>Tags:</span>
<a class=badge href=/systology/tags/deduplication/>deduplication</a></div></header><section><h2 id=idempotent-operations>Idempotent Operations</h2><p>Design migrations to be idempotent using manifests and checksums with destination markers to skip processed items. Idempotence makes retries safe and enables resumability without special cases.</p><p>Concretely, before processing each item, check the destination for a marker (a checksum file, a database flag, or the item itself). If the marker exists and the checksum matches, skip. If it&rsquo;s missing or stale, process and write the marker atomically. This turns your migration into a convergent operation‚Äîyou can run it 10 times and get the same result as running it once.</p><p>See how <a href=https://sambyte.net/systology/deep-dives/photohaul/>Photohaul</a> implements destination-side dedup markers to make multi-backend migrations safely resumable.</p><p><strong>Anti-pattern ‚Äî &ldquo;Just Don&rsquo;t Run It Twice&rdquo;:</strong> Relying on human discipline to avoid re-running a migration. Network glitches, OOM kills, and operator error will cause re-runs. If your migration creates duplicates when retried, you haven&rsquo;t built a migration‚Äîyou&rsquo;ve built a footgun. Idempotence is not optional for production migrations.</p><h2 id=efficient-deduplication>Efficient Deduplication</h2><p>Use robust hashing (SHA-256, perceptual hashes) with collision detection and balance speed against false positive rates. Different dedup needs (file vs. image) may need different hash types.</p><p>For exact file dedup, SHA-256 is the standard‚Äîcollisions are astronomically unlikely and the hash is well-supported everywhere. For near-duplicate image detection (same photo with different crops, compression, or watermarks), use perceptual hashes like pHash or dHash that tolerate visual similarity. For very large file sets, use a two-stage approach: fast hash (xxHash, CRC32) for a first pass, then SHA-256 only for potential duplicates.</p><p><strong>Anti-pattern ‚Äî MD5 for Dedup:</strong> Using MD5 because &ldquo;it&rsquo;s fast enough.&rdquo; MD5 has known collision vulnerabilities, and while accidental collisions are rare, adversarial collisions are trivial to construct. For any security-sensitive dedup (financial records, legal documents), use SHA-256. For non-sensitive dedup, xxHash is faster and collision-resistant.</p><p><strong>Anti-pattern ‚Äî Hash Only, No Verification:</strong> Treating hash matches as definitive proof of duplication without secondary verification. For critical data, compare file sizes and sample bytes after a hash match. The cost of a false positive (deleting a unique file) can far exceed the cost of a secondary check.</p><h2 id=resumability--checkpoints>Resumability & Checkpoints</h2><p>Partition work into shards with persistent progress manifests and store checkpoints at intervals. Resumability from checkpoints turns hours-long jobs into recoverable steps.</p><p>Split the input into logical shards (by directory, by file prefix, by date range) and track each shard&rsquo;s progress independently. Write progress to a manifest file (JSON or SQLite) after each shard completes. On restart, read the manifest, skip completed shards, and resume from where you left off. For large shards, checkpoint progress within each shard at intervals (e.g., every 1000 files).</p><p>See the <a href=https://sambyte.net/systology/designs/background-job-queue/>Background Job Queue</a> design for how job-level checkpointing enables reliable processing of large workloads with retries.</p><p><strong>Anti-pattern ‚Äî All-or-Nothing Migration:</strong> Processing 100,000 files in a single transaction that either fully succeeds or fully fails. A single error at file 99,999 forces you to reprocess everything from scratch. Shard the work and checkpoint progress so failures only affect the current shard.</p><h2 id=metadata-fidelity>Metadata Fidelity</h2><p>Preserve EXIF data, timestamps, and original filenames during migration. Metadata often matters for downstream use cases and audit trails.</p><p>Create a metadata sidecar (JSON, SQLite) that maps each migrated file to its original path, creation timestamp, EXIF data, and migration timestamp. This enables auditing (&ldquo;where did this file come from?&rdquo;), rollbacks (&ldquo;put it back where it was&rdquo;), and dedup refinement (&ldquo;are these the same file from different sources?&rdquo;). When the destination format supports metadata (S3 object tags, Google Drive properties), write it there too.</p><p>See the <a href=https://sambyte.net/systology/principles/media-analysis/>Media Analysis</a> principles for related guidance on preserving EXIF and codec metadata during processing pipelines.</p><p><strong>Anti-pattern ‚Äî Rename to UUID:</strong> Renaming files to UUIDs during migration for simplicity. Original filenames often carry semantic meaning (dates, descriptions, project names) that&rsquo;s impossible to reconstruct. Preserve the original name in metadata even if you need a system-assigned ID for storage.</p><h2 id=backend-specific-robustness>Backend-specific Robustness</h2><p>Implement retry strategies with exponential backoff for API failures and handle rate limits with adaptive delays. Each backend (S3, GCS, Dropbox) has its own quirks; abstract them.</p><p>Create a backend interface with <code>upload</code>, <code>download</code>, <code>exists</code>, and <code>list</code> operations. Behind each implementation, handle the provider&rsquo;s specific error codes: S3&rsquo;s <code>SlowDown</code> errors, Dropbox&rsquo;s <code>too_many_write_operations</code>, Google Drive&rsquo;s <code>rateLimitExceeded</code>. Use exponential backoff with jitter (start at 1s, cap at 60s) and circuit-breaker patterns for sustained failures.</p><p>See the <a href=https://sambyte.net/systology/principles/networking-services/>Networking & Services</a> principles for complete guidance on retry strategies, rate limiting, and connection management that applies to all backend integrations.</p><p><strong>Anti-pattern ‚Äî Retry Everything Identically:</strong> Using the same retry strategy for all backends (e.g., 3 retries with 1s delay). S3 handles 3,500 PUT requests per second per prefix; Dropbox allows 6 concurrent uploads. Your retry strategy needs to respect per-backend rate limits and adapt delays accordingly.</p><h2 id=dry-run--verification>Dry-run & Verification</h2><p>Support &ndash;dry-run mode with detailed operation manifests and include post-migration checksum verification. Dry-run turns risky operations into safe previews.</p><p>In dry-run mode, walk through every step the migration would perform and write a manifest of planned operations: <code>{action: "copy", source: "/photos/2024/img001.jpg", dest: "s3://bucket/2024/img001.jpg", size: 4823619}</code>. Let the operator review the manifest before committing. After the actual migration, run a verification pass that checksums every file at the destination against the source.</p><p><strong>Anti-pattern ‚Äî YOLO Migration:</strong> Running a migration against production data without a dry-run first. &ldquo;It worked on staging&rdquo; means nothing when staging has 100 files and production has 100,000 with different edge cases (special characters in filenames, zero-byte files, symlinks). Always preview, verify, then commit.</p><h2 id=parallelism--io>Parallelism & IO</h2><p>Use configurable concurrency for hashing and uploads and apply rate limiting to avoid saturating network or disk. Parallelism helps but synchronization overhead grows with concurrency.</p><p>Optimal concurrency depends on the bottleneck: for CPU-bound hashing, use <code>num_cpus</code> workers; for network-bound uploads, experiment with 4‚Äì32 concurrent connections (more may cause provider throttling); for local disk IO, 2‚Äì4 parallel readers typically saturate an SSD. Expose concurrency as a <code>--workers N</code> flag and log throughput per-worker to help users tune.</p><p>See the <a href=https://sambyte.net/systology/principles/algorithms-performance/>Algorithms & Performance</a> principles for deeper guidance on parallelism measurement and tuning worker counts.</p><p><strong>Anti-pattern ‚Äî Max Parallelism:</strong> Setting worker count to 128 because &ldquo;more threads = faster.&rdquo; Beyond the bottleneck saturation point, additional workers add contention (lock contention, network congestion, disk seeks) without increasing throughput. Benchmark with 1, 4, 16, 32 workers and find the knee of the curve.</p><h2 id=safe-defaults>Safe Defaults</h2><p>Default to conservative operations that preserve originals and require explicit confirmation for destructive actions. Reversibility is a feature.</p><p>The default mode should be copy-not-move: keep originals intact until the migration is verified. Destructive operations (deleting originals, overwriting conflicts) require explicit flags (<code>--delete-originals</code>, <code>--overwrite</code>). Show a summary and require confirmation before destructive actions: <code>"This will delete 47,832 files from /photos/. Type 'yes' to confirm."</code>.</p><p><strong>Anti-pattern ‚Äî Delete on Success:</strong> Automatically deleting source files as soon as they&rsquo;re uploaded. A network corruption during upload could go undetected, leaving you with a corrupted copy and no original. Keep originals until a separate verification pass confirms every file was transferred intact. Only then offer deletion as an explicit, separate step.</p><h2 id=decision-framework>Decision Framework</h2><p>Choose your migration strategy based on the data volume and the required uptime for the system:</p><table><thead><tr><th style=text-align:left>If you need&mldr;</th><th style=text-align:left>&mldr;choose this</th><th style=text-align:left>because&mldr;</th></tr></thead><tbody><tr><td style=text-align:left><strong>Zero Downtime</strong></td><td style=text-align:left>Dual-Write / Shadow-Read</td><td style=text-align:left>Verifies data in parallel before switching over the read path.</td></tr><tr><td style=text-align:left><strong>Operational Simplicity</strong></td><td style=text-align:left>Offline Batch Move</td><td style=text-align:left>Cleanest approach; avoids complex dual-write logic if downtime is okay.</td></tr><tr><td style=text-align:left><strong>High Data Integrity</strong></td><td style=text-align:left>Snapshot Comparison</td><td style=text-align:left>Directly compares source and sink to catch silent corruption.</td></tr><tr><td style=text-align:left><strong>Resumeability</strong></td><td style=text-align:left>Checkpointed Markers</td><td style=text-align:left>Ensures large migrations can restart from where they left off after failure.</td></tr></tbody></table><p><strong>Decision Heuristic:</strong> &ldquo;Choose <strong>Shadow-Reads</strong> before committing to a full cutover. Seeing real traffic fail on the new system is better than finding out after the old one is deleted.&rdquo;</p></section><aside class=related><h3>Related</h3><ul><li><a href=/systology/designs/migration-dedup/>End-to-End Migration & Deduplication</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>System design for migrating large datasets with deduplication, integrity checks, resumability, and idempotence.</small></li><li><a href=/systology/deep-dives/photohaul/>Photohaul</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Java tool for organizing and migrating large photo collections with deduplication, metadata preservation, and resumable jobs.</small></li></ul></aside></article></main><footer class=site-footer role=contentinfo><div class="container footer-inner"><p class=copyright>&copy; 2026 Systology. All rights reserved.</p><div class=social-links><a href=https://github.com/huangsam target=_blank rel="noopener noreferrer" aria-label=GitHub><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=http://linkedin.com/in/sambyte target=_blank rel="noopener noreferrer" aria-label=LinkedIn><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></footer><div id=site-search-modal class=site-search-modal-container style=display:none><div class=site-search-overlay data-close-search></div><div class=site-search-modal><div class=site-search-header><div class=site-search-input-wrapper><span class=site-search-icon><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</span><input type=text class=site-search-input id=site-search-input placeholder="Search designs, principles, deep dives..." aria-label=Search autocomplete=off>
<button class=site-search-close data-close-search>&#215;</button></div></div><div class=site-search-body><div id=site-search-default class=site-search-default><div class=site-search-quick-links><a href=/systology/categories/ class=site-search-cta><span class=site-search-cta-icon>üìÇ</span>
<span class=site-search-cta-text>All Categories</span>
<span class=site-search-cta-arrow>‚Üí</span>
</a><a href=/systology/tags/ class=site-search-cta><span class=site-search-cta-icon>üè∑Ô∏è</span>
<span class=site-search-cta-text>All Tags</span>
<span class=site-search-cta-arrow>‚Üí</span></a></div></div><div id=site-search-results-list style=display:none></div></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){let i=null,o=null;const t=document.getElementById("site-search-modal"),n=document.getElementById("site-search-input"),s=document.getElementById("site-search-default"),e=document.getElementById("site-search-results-list"),d=document.querySelectorAll("[data-close-search]"),h=document.querySelectorAll("[data-open-search]");if(!t)return;document.body.appendChild(t);let l=!1;function u(){if(l)return;fetch("/systology/search-index.json").then(e=>e.json()).then(e=>{i=e.documents,l=!0}).catch(e=>console.error("Failed to load search index:",e))}function r(){u(),t.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{n.focus(),n.value.trim()?c(n.value):(s.style.display="block",e.style.display="none")},50)}function a(){t.style.display="none",document.body.style.overflow="",n.value="",e.innerHTML="",s.style.display="block",e.style.display="none"}h.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),r()})}),d.forEach(e=>{e.addEventListener("click",a)});function c(t){if(!i)return;if(!t.trim()){s.style.display="block",e.style.display="none",e.innerHTML="";return}s.style.display="none",e.style.display="block",t=t.toLowerCase();const n=i.filter(e=>{const n=e.content.toLowerCase(),s=e.title.toLowerCase(),o=(e.tags||[]).join(" ").toLowerCase();return n.includes(t)||s.includes(t)}).slice(0,15);n.length===0?e.innerHTML='<p class="site-search-no-results">No results found.</p>':e.innerHTML=n.map(e=>`
        <a href="${e.url}" class="site-search-result">
          <div class="site-search-result-title">${e.title}</div>
          <div class="site-search-result-preview">${e.preview}</div>
          <div class="site-search-result-meta">
            <span class="site-search-badge-category">${e.category}</span>
            ${e.tags.map(e=>`<span class="site-search-badge">${e}</span>`).join("")}
          </div>
        </a>
      `).join("")}n.addEventListener("input",function(e){o&&clearTimeout(o),o=setTimeout(()=>{c(e.target.value)},300)}),document.addEventListener("keydown",function(e){(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),t.style.display==="none"||t.style.display===""?r():a()),e.key==="Escape"&&t.style.display==="flex"&&a()})})</script><script>document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".pseudocode-toggle"),n=document.querySelectorAll(".pseudocode-modal-close"),s=document.querySelectorAll(".pseudocode-modal-overlay");function o(e){const t=document.getElementById(e);if(!t)return;t.classList.add("active"),t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const n=t.querySelector(".pseudocode-modal-close");n&&n.focus()}function e(e){if(!e)return;e.classList.remove("active"),e.setAttribute("aria-hidden","true"),document.body.style.overflow="";const t=document.querySelector(`.pseudocode-toggle[aria-controls="${e.id}"]`);t&&t.focus()}t.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("aria-controls");o(t)})}),n.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),s.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const t=document.querySelector(".pseudocode-modal.active");t&&e(t)}})})</script><script src=/systology/js/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){window.mermaid&&mermaid.initialize({startOnLoad:!0,theme:"base",securityLevel:"loose",themeVariables:{primaryColor:"#f3f4f6",primaryTextColor:"#0f1724",primaryBorderColor:"#2563eb",lineColor:"#6b7280",secondBkgColor:"#ffffff",tertiaryTextColor:"#6b7280",tertiaryColor:"#e6e9ee",noteBkgColor:"#f0f9ff",noteBorderColor:"#2563eb",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},flowchart:{useMaxWidth:!0,curve:"linear"},sequence:{useMaxWidth:!0},gantt:{useWidth:0[0]}});var e=document.getElementById("theme-toggle");e&&e.addEventListener("click",function(){var e=document.documentElement.getAttribute("data-theme")==="dark";document.documentElement.setAttribute("data-theme",e?"":"dark");try{localStorage.setItem("theme",e?"light":"dark")}catch{}})})</script></body></html>