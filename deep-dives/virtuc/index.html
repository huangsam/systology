<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>VirtuC - Systology</title><meta name=description content="Rust compiler for a C subset targeting LLVM IR."><link rel=canonical href=https://sambyte.net/systology/deep-dives/virtuc/><link rel=icon href=/systology/favicon.svg type=image/svg+xml><meta name=robots content="index, follow"><script>try{localStorage.getItem("theme")==="dark"&&document.documentElement.setAttribute("data-theme","dark")}catch{}</script><style>html{background:#fff}html[data-theme=dark]{background:#0f1724}</style><link rel=stylesheet href=/systology/css/styles.css><link rel=stylesheet href=/systology/css/syntax.css><link rel=stylesheet href=/systology/css/search.css></head><body><header class=site-header role=banner><div class="container header-inner"><a class=brand href=/systology/ aria-label=Systology><img src=/systology/favicon.svg alt class=logo-icon> Systology</a><nav class=site-nav role=navigation aria-label="Main navigation"><button class=search-toggle data-open-search aria-label=Search>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</button>
<button class=theme-toggle id=theme-toggle aria-label="Toggle dark mode">
<svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></nav></div></header><main id=content class="container prose"><article><header><div class=title-group><h1>VirtuC</h1><a class=link-pill href=https://github.com/huangsam/virtuc target=_blank rel=noopener title="View on GitHub">GH</a></div><h2>Rust compiler for a C subset targeting LLVM IR.</h2><div class=tags><span>Tags:</span>
<a class=badge href=/systology/tags/algorithms/>algorithms</a>
<a class=badge href=/systology/tags/compiler/>compiler</a>
<a class=badge href=/systology/tags/performance/>performance</a>
<a class=badge href=/systology/tags/rust/>rust</a></div></header><section><h2 id=context--motivation>Context & Motivation</h2><p><strong>Context:</strong> <code>VirtuC</code> is a Rust-implemented compiler for a C subset that emits LLVM IR and produces native executables via <code>clang</code>. It serves as both an educational tool for understanding compiler internals and a testbed for exploring IR generation, optimization passes, and error reporting design.</p><p><strong>Motivation:</strong> I built part of a compiler in college with <a href=https://github.com/huangsam/ec2prog>huangsam/ec2prog</a>, but wanted to explore a more structured approach with Rust&rsquo;s type system, LLVM IR generation, and modern error reporting techniques.</p><h2 id=the-local-implementation>The Local Implementation</h2><ul><li><strong>Current Logic:</strong> The pipeline flows through four distinct phases. Phase 1 (Lexing): <code>logos</code> tokenizes source into a typed token stream with source spans. Phase 2 (Parsing): <code>nom</code> combinators consume tokens and build a typed AST with <code>Span</code> annotations on every node. Phase 3 (Semantic Analysis): a pass over the AST resolves symbols (variable/function lookup via a scoped symbol table), checks types (integer widths, pointer compatibility, function signatures), and annotates the AST with resolved type information. Phase 4 (Codegen): <code>inkwell</code> (a safe LLVM binding) lowers the annotated AST to LLVM IR‚Äî<code>alloca</code> for locals, proper <code>phi</code> nodes for control flow merges, and correct calling conventions for function calls. The CLI compiles the IR to an object file and links with <code>clang</code>.</li><li><strong>Error reporting:</strong> diagnostics include source file, line, column, a snippet of the offending code with an underline caret, and a suggestion when possible (e.g., <code>"did you mean 'int'?"</code> for typos). The parser implements error recovery by synchronizing on statement boundaries (semicolons, closing braces), allowing it to report multiple independent errors per compilation rather than bailing on the first one. Error output is modeled after Rust&rsquo;s compiler‚Äîclear, actionable, and never cryptic.</li><li><strong>Bottleneck:</strong> Expanding the supported C subset (structs, unions, enums, switch statements) requires extending all four phases in coordination. Ensuring correct IR lowering for edge cases (pointer arithmetic, implicit integer promotions, short-circuit evaluation) requires both snapshot tests of emitted IR and end-to-end execution tests.</li></ul><h2 id=comparison-to-industry-standards>Comparison to Industry Standards</h2><ul><li><strong>My Project:</strong> Small, focused compiler aimed at education and experimentation with LLVM IR. Emphasizes clear phase boundaries, readable error messages, and inspectable intermediate representations over optimization depth.</li><li><strong>Industry:</strong> Production compilers (clang, gcc) have decades of optimization passes, sophisticated register allocation, link-time optimization, and support for the full C/C++ specification. They also have extensive fuzz testing infrastructure (csmith, afl) for finding miscompilation bugs.</li><li><strong>Gap Analysis:</strong> To approach production robustness: add a verifier pass after IR generation that checks structural invariants (SSA dominance, type consistency, well-formed control flow), expand the fuzz testing suite with random program generation, implement at least basic optimization passes (constant folding, dead code elimination) gated behind <code>-O</code> flags, and add cross-compilation support for multiple target architectures.</li></ul><h2 id=risks--mitigations>Risks & Mitigations</h2><ul><li><strong>IR correctness bugs:</strong> compare VirtuC&rsquo;s output against <code>clang -S -emit-llvm</code> for the same input programs and diff the IR. Integrate FileCheck-style assertions for IR structure. Run a verifier pass after every codegen to catch malformed IR before it reaches LLVM&rsquo;s backend.</li><li><strong>Undefined behavior from unhandled constructs:</strong> reject unsupported C constructs explicitly with clear error messages (&ldquo;VirtuC does not support <code>goto</code>; use structured control flow&rdquo;) rather than silently generating wrong code. Maintain a documented list of supported vs. unsupported features.</li><li><strong>Error recovery correctness:</strong> test that parser recovery doesn&rsquo;t produce cascading false errors. Maintain a regression suite of multi-error programs and verify that only genuine errors are reported.</li><li><strong>LLVM version drift:</strong> pin the <code>inkwell</code>/LLVM version and test against multiple LLVM releases in CI to detect API breakage early.</li></ul></section><aside class=related><h3>Related</h3><ul><li><a href=/systology/principles/algorithms-performance/>Algorithms & Performance</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Principles for clear algorithms and performance engineering: micro-benchmarks, memory discipline, and deterministic generators.</small></li><li><a href=/systology/principles/compiler/>Compiler Design</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Guidelines for compiler design: clear IR boundaries, deterministic semantics, robust error reporting, and incremental compilation.</small></li><li><a href=/systology/designs/distributed-cache/>Distributed Caching Layer for VCS</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Design a distributed cache to reduce I/O and speed up VCS operations by caching objects and hashes with high concurrency and low latency.</small></li><li><a href=/systology/designs/flash-sale/>Flash Sale / Ticketmaster</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Design for handling extreme bursts of traffic where limited inventory must be distributed fairly and consistently under heavy load.</small></li></ul></aside></article></main><footer class=site-footer role=contentinfo><div class="container footer-inner"><p class=copyright>&copy; 2026 Systology. All rights reserved.</p><div class=social-links><a href=https://github.com/huangsam target=_blank rel="noopener noreferrer" aria-label=GitHub><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=http://linkedin.com/in/sambyte target=_blank rel="noopener noreferrer" aria-label=LinkedIn><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></footer><div id=site-search-modal class=site-search-modal-container style=display:none><div class=site-search-overlay data-close-search></div><div class=site-search-modal><div class=site-search-header><div class=site-search-input-wrapper><span class=site-search-icon><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</span><input type=text class=site-search-input id=site-search-input placeholder="Search designs, principles, deep dives..." aria-label=Search autocomplete=off>
<button class=site-search-close data-close-search>&#215;</button></div></div><div class=site-search-body><div id=site-search-default class=site-search-default><div class=site-search-quick-links><a href=/systology/categories/ class=site-search-cta><span class=site-search-cta-icon>üìÇ</span>
<span class=site-search-cta-text>All Categories</span>
<span class=site-search-cta-arrow>‚Üí</span>
</a><a href=/systology/tags/ class=site-search-cta><span class=site-search-cta-icon>üè∑Ô∏è</span>
<span class=site-search-cta-text>All Tags</span>
<span class=site-search-cta-arrow>‚Üí</span></a></div></div><div id=site-search-results-list style=display:none></div></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){let i=null,o=null;const t=document.getElementById("site-search-modal"),n=document.getElementById("site-search-input"),s=document.getElementById("site-search-default"),e=document.getElementById("site-search-results-list"),d=document.querySelectorAll("[data-close-search]"),h=document.querySelectorAll("[data-open-search]");if(!t)return;document.body.appendChild(t);let l=!1;function u(){if(l)return;fetch("/systology/search-index.json").then(e=>e.json()).then(e=>{i=e.documents,l=!0}).catch(e=>console.error("Failed to load search index:",e))}function r(){u(),t.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{n.focus(),n.value.trim()?c(n.value):(s.style.display="block",e.style.display="none")},50)}function a(){t.style.display="none",document.body.style.overflow="",n.value="",e.innerHTML="",s.style.display="block",e.style.display="none"}h.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),r()})}),d.forEach(e=>{e.addEventListener("click",a)});function c(t){if(!i)return;if(!t.trim()){s.style.display="block",e.style.display="none",e.innerHTML="";return}s.style.display="none",e.style.display="block",t=t.toLowerCase();const n=i.filter(e=>{const n=e.content.toLowerCase(),s=e.title.toLowerCase(),o=(e.tags||[]).join(" ").toLowerCase();return n.includes(t)||s.includes(t)}).slice(0,15);n.length===0?e.innerHTML='<p class="site-search-no-results">No results found.</p>':e.innerHTML=n.map(e=>`
        <a href="${e.url}" class="site-search-result">
          <div class="site-search-result-title">${e.title}</div>
          <div class="site-search-result-preview">${e.preview}</div>
          <div class="site-search-result-meta">
            <span class="site-search-badge-category">${e.category}</span>
            ${e.tags.map(e=>`<span class="site-search-badge">${e}</span>`).join("")}
          </div>
        </a>
      `).join("")}n.addEventListener("input",function(e){o&&clearTimeout(o),o=setTimeout(()=>{c(e.target.value)},300)}),document.addEventListener("keydown",function(e){(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),t.style.display==="none"||t.style.display===""?r():a()),e.key==="Escape"&&t.style.display==="flex"&&a()})})</script><script>document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".pseudocode-toggle"),n=document.querySelectorAll(".pseudocode-modal-close"),s=document.querySelectorAll(".pseudocode-modal-overlay");function o(e){const t=document.getElementById(e);if(!t)return;t.classList.add("active"),t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const n=t.querySelector(".pseudocode-modal-close");n&&n.focus()}function e(e){if(!e)return;e.classList.remove("active"),e.setAttribute("aria-hidden","true"),document.body.style.overflow="";const t=document.querySelector(`.pseudocode-toggle[aria-controls="${e.id}"]`);t&&t.focus()}t.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("aria-controls");o(t)})}),n.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),s.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const t=document.querySelector(".pseudocode-modal.active");t&&e(t)}})})</script><script src=/systology/js/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){window.mermaid&&mermaid.initialize({startOnLoad:!0,theme:"base",securityLevel:"loose",themeVariables:{primaryColor:"#f3f4f6",primaryTextColor:"#0f1724",primaryBorderColor:"#2563eb",lineColor:"#6b7280",secondBkgColor:"#ffffff",tertiaryTextColor:"#6b7280",tertiaryColor:"#e6e9ee",noteBkgColor:"#f0f9ff",noteBorderColor:"#2563eb",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},flowchart:{useMaxWidth:!0,curve:"linear"},sequence:{useMaxWidth:!0},gantt:{useWidth:0[0]}});var e=document.getElementById("theme-toggle");e&&e.addEventListener("click",function(){var e=document.documentElement.getAttribute("data-theme")==="dark";document.documentElement.setAttribute("data-theme",e?"":"dark");try{localStorage.setItem("theme",e?"light":"dark")}catch{}})})</script></body></html>