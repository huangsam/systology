<div class="site-search-container">
  <div class="site-search-input-wrapper">
    <input type="text" class="site-search-input" id="site-search-input"
      placeholder="Search designs, principles, deep dives..." aria-label="Search" autocomplete="off" />
    <span class="site-search-icon">üîç</span>
  </div>
</div>

<div id="site-search-results" class="site-search-results" style="display: none;">
  <div class="site-search-results-overlay" data-close-search></div>
  <div class="site-search-results-modal">
    <div class="site-search-results-header">
      <h3>Search Results</h3>
      <button class="site-search-results-close" data-close-search>&times;</button>
    </div>
    <div class="site-search-results-body" id="site-search-results-list">
      <!-- Results injected here -->
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let searchIndex = null;
    let debounceTimer = null;
    const searchInput = document.getElementById('site-search-input');
    const searchResults = document.getElementById('site-search-results');
    const searchResultsList = document.getElementById('site-search-results-list');
    const closeButtons = document.querySelectorAll('[data-close-search]');

    if (!searchInput) return;

    // Move results to body to avoid z-index/transform issues
    document.body.appendChild(searchResults);

    // Load search index
    fetch('/search-index.json')
      .then(res => res.json())
      .then(data => {
        searchIndex = data.documents;
      })
      .catch(err => console.error('Failed to load search index:', err));

    function performSearch(query) {
      if (!searchIndex || !query.trim()) {
        searchResults.style.display = 'none';
        return;
      }

      query = query.toLowerCase();
      const results = searchIndex.filter(doc => {
        const content = doc.content.toLowerCase();
        const title = doc.title.toLowerCase();
        const tags = (doc.tags || []).join(' ').toLowerCase();
        return content.includes(query) || title.includes(query);
      }).slice(0, 15);

      if (results.length === 0) {
        searchResultsList.innerHTML = '<p class="site-search-no-results">No results found.</p>';
      } else {
        searchResultsList.innerHTML = results.map(doc => `
        <a href="${doc.url}" class="site-search-result">
          <div class="site-search-result-title">${doc.title}</div>
          <div class="site-search-result-preview">${doc.preview}</div>
          <div class="site-search-result-meta">
            <span class="site-search-badge-category">${doc.category}</span>
            ${doc.tags.map(tag => `<span class="site-search-badge">${tag}</span>`).join('')}
          </div>
        </a>
      `).join('');
      }

      searchResults.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.body.classList.add('search-active');
    }

    searchInput.addEventListener('input', function (e) {
      // Clear existing timer
      if (debounceTimer) clearTimeout(debounceTimer);

      // Set new timer - only search after 300ms of no typing
      debounceTimer = setTimeout(() => {
        performSearch(e.target.value);
      }, 300);
    });

    function closeSearch() {
      searchResults.style.display = 'none';
      document.body.style.overflow = 'auto';
      document.body.classList.remove('search-active');
      searchInput.value = '';
      if (debounceTimer) clearTimeout(debounceTimer);
    }

    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeSearch();
        searchInput.blur();
      }
    });

    closeButtons.forEach(btn => {
      btn.addEventListener('click', closeSearch);
    });

    // Close on overlay click
    document.querySelector('.site-search-results-overlay')?.addEventListener('click', closeSearch);
  });
</script>