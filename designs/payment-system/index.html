<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Payment System - Systology</title><meta name=description content="Handling global transactions with high reliability and consistency."><link rel=canonical href=https://sambyte.net/systology/designs/payment-system/><link rel=icon href=/systology/favicon.svg type=image/svg+xml><meta name=robots content="index, follow"><script>try{localStorage.getItem("theme")==="dark"&&document.documentElement.setAttribute("data-theme","dark")}catch{}</script><style>html{background:#fff;color:#0f1724}html[data-theme=dark]{background:#0f1724;color:#e2e8f0}</style><link rel=stylesheet href=/systology/css/styles.css><link rel=stylesheet href=/systology/css/syntax.css><link rel=stylesheet href=/systology/css/search.css></head><body><header class=site-header role=banner><div class="container header-inner"><a class=brand href=/systology/ aria-label=Systology><img src=/systology/favicon.svg alt class=logo-icon> Systology</a><nav class=site-nav role=navigation aria-label="Main navigation"><button class=search-toggle data-open-search aria-label=Search>
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</button>
<button class=theme-toggle id=theme-toggle aria-label="Toggle dark mode">
<svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></nav></div></header><main id=content class="container prose"><article><header><div class=title-group><h1>Payment System</h1></div><h2>Handling global transactions with high reliability and consistency.</h2><div class=tags><span>Tags:</span>
<a class=badge href=/systology/tags/algorithms/>algorithms</a>
<a class=badge href=/systology/tags/database/>database</a>
<a class=badge href=/systology/tags/distributed-systems/>distributed-systems</a></div></header><section><h2 id=problem-statement--constraints>Problem Statement & Constraints</h2><p>Design a robust payment system that processes customer transactions via third-party gateways (e.g., Stripe, PayPal) while maintaining a high-fidelity internal ledger. The system must handle millions of transactions daily, ensuring that no customer is double-charged and every payment is accurately reconciled.</p><h3 id=functional-requirements>Functional Requirements</h3><ul><li>Process customer payments via multiple payment gateways.</li><li>Handle refunds, disputes, and state transitions.</li><li>Maintain a double-entry ledger for all transactions.</li><li>Provide idempotency and deduplication for all operations.</li></ul><h3 id=non-functional-requirements>Non-Functional Requirements</h3><ul><li><strong>Scale:</strong> 1M transactions/day; peak 100 TPS.</li><li><strong>Availability:</strong> 99.99% for critical payment paths.</li><li><strong>Consistency:</strong> Strict ACID compliance for ledger; external consistency via idempotency keys; eventual for analytics.</li><li><strong>Latency:</strong> P99 &lt; 2 seconds for payment processing.</li><li><strong>Workload Profile:</strong><ul><li>Read:Write ratio: ~30:70</li><li>Peak throughput: 100 TPS</li><li>Retention: 7-year ledger; 30 days hot metrics</li></ul></li></ul><h2 id=high-level-architecture>High-Level Architecture</h2><div class=mermaid>graph TD
Client --> API
API --> PSM[State Machine]
PSM --> GW[Gateway]
GW --> Stripe
GW --> PayPal
PSM --> Ledger[(Ledger)]
PSM --> Bus[Events]
Bus --> Hooks[Webhooks]
Bus --> Recon
Recon --> Ledger</div><p>An API receives client requests, driving a Payment State Machine that orchestrates the transaction lifecycle. The State Machine calls external Gateways to authorize and capture funds, while synchronously writing double-entry records to a durable Ledger. All state transitions publish to an Event Bus, triggering downstream webhooks and offline Reconciliation.</p><h2 id=data-design>Data Design</h2><p>An Idempotency Store (Redis/Postgres) caches request signatures to prevent double-charging. The core Internal Ledger uses a relational database with append-only tables for immutable debit and credit entries, ensuring strict financial balance.</p><h3 id=idempotency-store-redispostgres>Idempotency Store (Redis/Postgres)</h3><table><thead><tr><th style=text-align:left>Key Pattern</th><th style=text-align:left>Value</th><th style=text-align:left>TTL</th><th style=text-align:left>Purpose</th></tr></thead><tbody><tr><td style=text-align:left><code>idem:&lt;key></code></td><td style=text-align:left>JSON Response</td><td style=text-align:left>24 Hours</td><td style=text-align:left>Prevent double-charges from retries.</td></tr><tr><td style=text-align:left><code>lock:&lt;user></code></td><td style=text-align:left>Boolean</td><td style=text-align:left>30 Seconds</td><td style=text-align:left>Distributed lock during active process.</td></tr></tbody></table><h3 id=internal-ledger-sql>Internal Ledger (SQL)</h3><table><thead><tr><th style=text-align:left>Table</th><th style=text-align:left>Column</th><th style=text-align:left>Type</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><strong>entries</strong></td><td style=text-align:left><code>id</code></td><td style=text-align:left>UUID (PK)</td><td style=text-align:left>Unique entry identifier.</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>account_id</code></td><td style=text-align:left>String (Idx)</td><td style=text-align:left>e.g., <code>user_123</code>, <code>gateway_stripe</code>.</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>amount</code></td><td style=text-align:left>BigInt</td><td style=text-align:left>Smallest unit (e.g. cents).</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>direction</code></td><td style=text-align:left>Enum</td><td style=text-align:left><code>debit</code>, <code>credit</code>.</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>tx_id</code></td><td style=text-align:left>UUID (FK)</td><td style=text-align:left>Reference to parent transaction.</td></tr></tbody></table><h2 id=deep-dive--trade-offs>Deep Dive & Trade-offs</h2><div class=pseudocode-container><button class=pseudocode-toggle aria-expanded=false aria-controls=idempotency-key>
<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
View Pseudocode: Idempotent Payment Processing</button><div id=idempotency-key class=pseudocode-modal aria-hidden=true role=dialog aria-labelledby=modalTitle-idempotency-key><div class=pseudocode-modal-overlay></div><div class=pseudocode-modal-content><div class=pseudocode-modal-header><h3 id=modalTitle-idempotency-key class=pseudocode-modal-title>Pseudocode: Idempotent Payment Processing</h3><button class=pseudocode-modal-close aria-label="Close modal">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button></div><div class=pseudocode-modal-body><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psycopg2</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>psycopg2.extras</span> <span class=kn>import</span> <span class=n>RealDictCursor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_payment</span><span class=p>(</span><span class=n>idempotency_key</span><span class=p>,</span> <span class=n>user_id</span><span class=p>,</span> <span class=n>amount</span><span class=p>,</span> <span class=n>currency</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. Start a database transaction</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>get_db_connection</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>(</span><span class=n>cursor_factory</span><span class=o>=</span><span class=n>RealDictCursor</span><span class=p>)</span> <span class=k>as</span> <span class=n>cur</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 2. Try to insert the idempotency key.</span>
</span></span><span class=line><span class=cl>            <span class=c1># If it exists, constraint violation occurs, preventing double processing.</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                    INSERT INTO idempotency_keys (key, status)
</span></span></span><span class=line><span class=cl><span class=s2>                    VALUES (</span><span class=si>%s</span><span class=s2>, &#39;processing&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>idempotency_key</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>psycopg2</span><span class=o>.</span><span class=n>IntegrityError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Key exists! Fetch the previous result/status and return it</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT status, response FROM idempotency_keys WHERE key = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>idempotency_key</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>                <span class=n>existing_record</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>existing_record</span><span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=s1>&#39;completed&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>existing_record</span><span class=p>[</span><span class=s1>&#39;response&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Concurrent request processing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 3. Proceed with external Gateway call (e.g., Stripe)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>stripe_charge</span> <span class=o>=</span> <span class=n>stripe</span><span class=o>.</span><span class=n>Charge</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>currency</span><span class=o>=</span><span class=n>currency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>source</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>idempotency_key</span><span class=o>=</span><span class=n>idempotency_key</span> <span class=c1># Pass down to Stripe too!</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 4. Write to internal Double-Entry Ledger</span>
</span></span><span class=line><span class=cl>                <span class=n>record_ledger_entries</span><span class=p>(</span><span class=n>cur</span><span class=p>,</span> <span class=n>charge_id</span><span class=o>=</span><span class=n>stripe_charge</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>amount</span><span class=o>=</span><span class=n>amount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 5. Update Idempotency record to &#39;completed&#39;</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                    UPDATE idempotency_keys
</span></span></span><span class=line><span class=cl><span class=s2>                    SET status = &#39;completed&#39;, response = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                    WHERE key = </span><span class=si>%s</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>                &#34;&#34;&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>stripe_charge</span><span class=o>.</span><span class=n>id</span><span class=p>,</span> <span class=n>idempotency_key</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>stripe_charge</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span> <span class=c1># Rollback ledger entries</span>
</span></span><span class=line><span class=cl>                <span class=c1># Make sure to free the idempotency key so user can retry, or mark as failed</span>
</span></span><span class=line><span class=cl>                <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;UPDATE idempotency_keys SET status = &#39;failed&#39; WHERE key = </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>idempotency_key</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>                <span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>e</span>
</span></span></code></pre></div></div></div></div></div><h3 id=deep-dive>Deep Dive</h3><ul><li><p><strong>Payment state machine:</strong> Strict transitions (<code>CREATED ‚Üí AUTHORIZED ‚Üí CAPTURED</code>) reject invalid moves. Every change persists atomically with full audit metadata.</p></li><li><p><strong>Double-entry ledger:</strong> Offsetting append-only debit/credit entries sum to zero. Corrections require new compensating entries, preserving the immutable audit trail.</p></li><li><p><strong>Gateway abstraction:</strong> A unified interface (<code>authorize</code>, <code>capture</code>) decouples business logic from provider APIs, easing routing and migrations.</p></li><li><p><strong>Reconciliation jobs:</strong> Hourly jobs validate gateway settlement reports against the ledger. Nightly deep passes re-derive balances from raw entries to catch subtle discrepancies.</p></li><li><p><strong>PCI-DSS isolation:</strong> Edge SDKs tokenize card data. The backend handles only opaque tokens in a secure vault, entirely bypassing PCI scope.</p></li><li><p><strong>Event-driven webhooks:</strong> Kafka/SNS dispatches state change events to downstream services with at-least-once delivery and HMAC signatures.</p></li><li><p><strong>Currency & FX:</strong> Integer math on smallest units (cents) avoids floating-point errors. Multi-currency tracks FX rates captured at exact authorization time.</p></li></ul><h3 id=trade-offs>Trade-offs</h3><ul><li><p><strong>Sync vs. Async Gateway Calls:</strong> Sync is simpler for clients but blocks during latency; Async (Webhooks) decouples latency but requires polling/WebSocket infra and client complexity.</p></li><li><p><strong>Append-only vs. Mutable Ledger:</strong> Append-only provides a tamper-evident audit trail but increases verbosity; Mutable is simpler for low-scale but risks integrity and auditing gaps.</p></li><li><p><strong>Single vs. Multi-gateway:</strong> Single is operationally simple but risks lock-in/SPOF; Multi-gateway improves resilience but adds routing, reconciliation, and integration complexity.</p></li></ul><h2 id=operational-excellence>Operational Excellence</h2><h3 id=slis--slos>SLIs / SLOs</h3><ul><li>SLO: 99.99% of payment API requests return a response (success or well-defined error) within 2 seconds.</li><li>SLO: 0 ledger imbalances (debits and credits sum to zero at all times).</li><li>SLIs: payment_success_rate, gateway_latency_p99, ledger_balance_check, reconciliation_discrepancy_count, idempotency_cache_hit_rate.</li></ul><h3 id=reliability--resiliency>Reliability & Resiliency</h3><ul><li><strong>Integrations</strong>: End-to-end flows against gateway sandboxes in CI.</li><li><strong>Chaos</strong>: Inject gateway timeouts to verify state machine and idempotency.</li><li><strong>Audit</strong>: Monthly balance re-derivation from raw entries vs. aggregates.</li></ul></section><aside class=related><h3>Related</h3><ul><li><a href=/systology/principles/algorithms-performance/>Algorithms & Performance</a>
<span class=related-type><small class=label-tag>tag</small></span><br><small class=muted>Principles for clear algorithms and performance engineering: micro-benchmarks, memory discipline, and deterministic generators.</small></li><li><a href=/systology/designs/background-job-queue/>Background Job Queue for Big Tasks</a>
<span class=related-type><small class=label-tag>tag</small>
<small class=label-cat>category</small></span><br><small class=muted>Asynchronous job queue design for resource-heavy tasks (video encoding, data processing) with retries, idempotency, DLQ handling, and autoscaling.</small></li><li><a href=/systology/designs/distributed-cache/>Distributed Caching Layer for VCS</a>
<span class=related-type><small class=label-tag>tag</small>
<small class=label-cat>category</small></span><br><small class=muted>Design a distributed cache to reduce I/O and speed up VCS operations by caching objects and hashes with high concurrency and low latency.</small></li><li><a href=/systology/designs/web-crawler/>Distributed Web Crawler</a>
<span class=related-type><small class=label-tag>tag</small>
<small class=label-cat>category</small></span><br><small class=muted>Design for a Google-scale web crawler focusing on Breadth-First Search (BFS), DNS resolution caching, robots.txt politeness, and handling duplicate or malicious domains.</small></li></ul></aside></article></main><footer class=site-footer role=contentinfo><div class="container footer-inner"><p class=copyright>&copy; 2026 Systology. All rights reserved.</p><div class=social-links><a href=https://github.com/huangsam target=_blank rel="noopener noreferrer" aria-label=GitHub><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=http://linkedin.com/in/sambyte target=_blank rel="noopener noreferrer" aria-label=LinkedIn><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-linkedin"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></div></footer><div id=site-search-modal class=site-search-modal-container style=display:none><div class=site-search-overlay data-close-search></div><div class=site-search-modal><div class=site-search-header><div class=site-search-input-wrapper><span class=site-search-icon><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
</span><input type=text class=site-search-input id=site-search-input placeholder="Search designs, principles, deep dives..." aria-label=Search autocomplete=off>
<button class=site-search-close data-close-search>&#215;</button></div></div><div class=site-search-body><div id=site-search-default class=site-search-default><div class=site-search-quick-links><a href=/systology/categories/ class=site-search-cta><span class=site-search-cta-icon>üìÇ</span>
<span class=site-search-cta-text>All Categories</span>
<span class=site-search-cta-arrow>‚Üí</span>
</a><a href=/systology/tags/ class=site-search-cta><span class=site-search-cta-icon>üè∑Ô∏è</span>
<span class=site-search-cta-text>All Tags</span>
<span class=site-search-cta-arrow>‚Üí</span></a></div></div><div id=site-search-results-list style=display:none></div></div></div></div><script>document.addEventListener("DOMContentLoaded",function(){let i=null,o=null;const t=document.getElementById("site-search-modal"),n=document.getElementById("site-search-input"),s=document.getElementById("site-search-default"),e=document.getElementById("site-search-results-list"),d=document.querySelectorAll("[data-close-search]"),h=document.querySelectorAll("[data-open-search]");if(!t)return;document.body.appendChild(t);let l=!1;function u(){if(l)return;fetch("/systology/search-index.json").then(e=>e.json()).then(e=>{i=e.documents,l=!0}).catch(e=>console.error("Failed to load search index:",e))}function r(){u(),t.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{n.focus(),n.value.trim()?c(n.value):(s.style.display="block",e.style.display="none")},50)}function a(){t.style.display="none",document.body.style.overflow="",n.value="",e.innerHTML="",s.style.display="block",e.style.display="none"}h.forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),r()})}),d.forEach(e=>{e.addEventListener("click",a)});function c(t){if(!i)return;if(!t.trim()){s.style.display="block",e.style.display="none",e.innerHTML="";return}s.style.display="none",e.style.display="block",t=t.toLowerCase();const n=i.filter(e=>{const n=e.content.toLowerCase(),s=e.title.toLowerCase(),o=(e.tags||[]).join(" ").toLowerCase();return n.includes(t)||s.includes(t)}).slice(0,15);n.length===0?e.innerHTML='<p class="site-search-no-results">No results found.</p>':e.innerHTML=n.map(e=>`
        <a href="${e.url}" class="site-search-result">
          <div class="site-search-result-title">${e.title}</div>
          <div class="site-search-result-preview">${e.preview}</div>
          <div class="site-search-result-meta">
            <span class="site-search-badge-category">${e.category}</span>
            ${e.tags.map(e=>`<span class="site-search-badge">${e}</span>`).join("")}
          </div>
        </a>
      `).join("")}n.addEventListener("input",function(e){o&&clearTimeout(o),o=setTimeout(()=>{c(e.target.value)},300)}),document.addEventListener("keydown",function(e){(e.metaKey||e.ctrlKey)&&e.key==="k"&&(e.preventDefault(),t.style.display==="none"||t.style.display===""?r():a()),e.key==="Escape"&&t.style.display==="flex"&&a()})})</script><script>document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll(".pseudocode-toggle"),n=document.querySelectorAll(".pseudocode-modal-close"),s=document.querySelectorAll(".pseudocode-modal-overlay");function o(e){const t=document.getElementById(e);if(!t)return;t.classList.add("active"),t.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const n=t.querySelector(".pseudocode-modal-close");n&&n.focus()}function e(e){if(!e)return;e.classList.remove("active"),e.setAttribute("aria-hidden","true"),document.body.style.overflow="";const t=document.querySelector(`.pseudocode-toggle[aria-controls="${e.id}"]`);t&&t.focus()}t.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("aria-controls");o(t)})}),n.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),s.forEach(t=>{t.addEventListener("click",t=>{const n=t.target.closest(".pseudocode-modal");e(n)})}),document.addEventListener("keydown",t=>{if(t.key==="Escape"){const t=document.querySelector(".pseudocode-modal.active");t&&e(t)}})})</script><script src=/systology/js/mermaid.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){window.mermaid&&mermaid.initialize({startOnLoad:!0,theme:"base",securityLevel:"loose",themeVariables:{primaryColor:"#f3f4f6",primaryTextColor:"#0f1724",primaryBorderColor:"#2563eb",lineColor:"#6b7280",secondBkgColor:"#ffffff",tertiaryTextColor:"#6b7280",tertiaryColor:"#e6e9ee",noteBkgColor:"#f0f9ff",noteBorderColor:"#2563eb",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},flowchart:{useMaxWidth:!0,curve:"linear"},sequence:{useMaxWidth:!0},gantt:{useWidth:0[0]}});var e=document.getElementById("theme-toggle");e&&e.addEventListener("click",function(){var e=document.documentElement.getAttribute("data-theme")==="dark";document.documentElement.setAttribute("data-theme",e?"":"dark");try{localStorage.setItem("theme",e?"light":"dark")}catch{}})})</script></body></html>